#ifndef TELEGRAM_HANDLER_H
#define TELEGRAM_HANDLER_H

#include <ESP8266WiFi.h>
#include <WiFiClientSecure.h>
#include <UniversalTelegramBot.h>
#include <ArduinoJson.h>
#include "config.h"
#include "credential.h"

// Forward declarations untuk dependencies
class Hardware;
class PowerManager;
class TimeManager;
class DataLogger;

class TelegramHandler {
private:
  static WiFiClientSecure client;
  static UniversalTelegramBot bot;
  static unsigned long lastBotRan;
  static const unsigned long BOT_INTERVAL = 1000; // Check messages every 1 second

public:
  static void init();
  static void checkMessages();1
  static void handleNewMessages(int numNewMessages);
  static void sendStartupNotification();
  static void sendFoodAlert(int level, bool critical);
  static void sendWaterAlert(int level, bool critical);
  static void sendBatteryAlert(float level, bool critical);
  static void sendAutoFeedNotification(String time);
  static String getMenuText();
  static String getStatusText();
  static void sendMessage(String message);
  static bool isTimeToCheck();
};

// Static member definitions
WiFiClientSecure TelegramHandler::client;
UniversalTelegramBot TelegramHandler::bot(BOT_TOKEN, client);
unsigned long TelegramHandler::lastBotRan = 0;

void TelegramHandler::init() {
  Serial.println("üîß Initializing Telegram Handler...");
  
  // Connect to WiFi
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  client.setInsecure();
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(1000);
    attempts++;
    Serial.println("Connecting to WiFi... Attempt " + String(attempts));
    Hardware::displayMessage("WiFi: " + String(attempts) + "/30");
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("WiFi connected: " + WiFi.localIP().toString());
    Hardware::displayMessage("WiFi Connected!");
    Serial.println("‚úÖ Telegram Handler initialized");
    
    // Send startup notification after a short delay
    delay(2000);
    sendStartupNotification();
  } else {
    Serial.println("‚ùå WiFi connection failed!");
    Hardware::displayMessage("WiFi Failed!");
  }
}

bool TelegramHandler::isTimeToCheck() {
  return (millis() - lastBotRan > BOT_INTERVAL);
}

void TelegramHandler::checkMessages() {
  if (!isTimeToCheck()) return;
  
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi not connected, skipping message check");
    return;
  }
  
  lastBotRan = millis();
  int numNewMessages = bot.getUpdates(bot.last_message_received + 1);
  
  while (numNewMessages) {
    handleNewMessages(numNewMessages);
    numNewMessages = bot.getUpdates(bot.last_message_received + 1);
  }
  
  PowerManager::updateActivity();
}

void TelegramHandler::handleNewMessages(int numNewMessages) {
  Serial.println("Handling " + String(numNewMessages) + " new messages");
  
  for (int i = 0; i < numNewMessages; i++) {
    String chat_id = String(bot.messages[i].chat_id);
    String from_name = bot.messages[i].from_name;
    
    // Security check - only authorized chat ID
    if (chat_id != CHAT_ID) {
      Serial.println("Unauthorized access attempt from: " + from_name + " (" + chat_id + ")");
      bot.sendMessage(chat_id, "‚ùå Unauthorized user. Access denied.", "");
      continue;
    }
    
    String text = bot.messages[i].text;
    Serial.println("Command received: " + text);
    
    // Command handling
    if (text == "/start") {
      String welcome = "üêπ Hamster Feeder Bot Online!\n\n";
      welcome += "Halo " + from_name + "! üëã\n";
      welcome += "Bot siap melayani hamster kesayangan Anda.\n\n";
      welcome += "Gunakan /menu untuk melihat semua perintah yang tersedia.";
      bot.sendMessage(chat_id, welcome, "");
    }
    else if (text == "/menu") {
      bot.sendMessage(chat_id, getMenuText(), "");
    }
    else if (text == "/status") {
      bot.sendMessage(chat_id, getStatusText(), "");
    }
    else if (text == "/info_makan") {
      int food = Hardware::getFoodLevel();
      String msg = "üçΩÔ∏è INFORMASI MAKANAN\n\n";
      msg += "Level: " + String(food) + "%\n";
      if (food > 30) {
        msg += "Status: Cukup ‚úÖ\n";
        msg += "Kondisi: Normal";
      } else if (food > 15) {
        msg += "Status: Rendah ‚ö†Ô∏è\n";
        msg += "Kondisi: Perlu diisi ulang segera";
      } else {
        msg += "Status: Kritis ‚ùå\n";
        msg += "Kondisi: SEGERA ISI MAKANAN!";
      }
      bot.sendMessage(chat_id, msg, "");
    }
    else if (text == "/info_minum") {
      int water = Hardware::getWaterLevel();
      String msg = "üíß INFORMASI MINUMAN\n\n";
      msg += "Level: " + String(water) + "%\n";
      if (water > 25) {
        msg += "Status: Cukup ‚úÖ\n";
        msg += "Kondisi: Normal";
      } else if (water > 10) {
        msg += "Status: Rendah ‚ö†Ô∏è\n";
        msg += "Kondisi: Perlu diisi ulang segera";
      } else {
        msg += "Status: Kritis ‚ùå\n";
        msg += "Kondisi: SEGERA ISI AIR!";
      }
      bot.sendMessage(chat_id, msg, "");
    }
    else if (text == "/makan") {
      bot.sendMessage(chat_id, "üçΩÔ∏è Sedang memberikan makanan...", "");
      bool success = Hardware::feedHamster();
      if (success) {
        DataLogger::logFeeding("MANUAL", TimeManager::getCurrentTime());
        bot.sendMessage(chat_id, "‚úÖ Makanan telah diberikan!\n‚è∞ " + TimeManager::getCurrentTimeString(), "");
      } else {
        bot.sendMessage(chat_id, "‚ùå Gagal memberikan makanan. Periksa hardware!", "");
      }
    }
    else if (text == "/jadwal") {
      bot.sendMessage(chat_id, TimeManager::getScheduleList(), "");
    }
    else if (text.startsWith("/tambah_jadwal ")) {
      String newTime = text.substring(15);
      newTime.trim(); // Remove whitespace
      
      if (TimeManager::isValidTimeFormat(newTime)) {
        bool added = TimeManager::addSchedule(newTime, true);
        if (added) {
          bot.sendMessage(chat_id, "‚úÖ Jadwal " + newTime + " berhasil ditambahkan!", "");
        } else {
          bot.sendMessage(chat_id, "‚ùå Gagal menambah jadwal. Mungkin sudah ada atau memori penuh.", "");
        }
      } else {
        bot.sendMessage(chat_id, "‚ùå Format waktu salah!\n\nGunakan format: HH:MM\nContoh: /tambah_jadwal 08:30", "");
      }
    }
    else if (text.startsWith("/hapus_jadwal ")) {
      String timeToDelete = text.substring(14);
      timeToDelete.trim();
      
      bool deleted = TimeManager::removeSchedule(timeToDelete);
      if (deleted) {
        bot.sendMessage(chat_id, "‚úÖ Jadwal " + timeToDelete + " berhasil dihapus!", "");
      } else {
        bot.sendMessage(chat_id, "‚ùå Jadwal tidak ditemukan atau gagal dihapus.", "");
      }
    }
    else if (text == "/data") {
      bot.sendMessage(chat_id, DataLogger::getDataSummary(), "");
    }
    else if (text == "/reboot") {
      bot.sendMessage(chat_id, "üîÑ Sistem akan restart dalam 5 detik...", "");
      delay(5000);
      ESP.restart();
    }
    else if (text == "/help") {
      String help = "üÜò BANTUAN PENGGUNAAN\n\n";
      help += "üìã Perintah dasar:\n";
      help += "‚Ä¢ /start - Mulai bot\n";
      help += "‚Ä¢ /menu - Tampilkan menu\n";
      help += "‚Ä¢ /status - Status lengkap sistem\n\n";
      help += "üçΩÔ∏è Makanan & Minuman:\n";
      help += "‚Ä¢ /info_makan - Cek level makanan\n";
      help += "‚Ä¢ /info_minum - Cek level air\n";
      help += "‚Ä¢ /makan - Beri makan manual\n\n";
      help += "‚è∞ Jadwal:\n";
      help += "‚Ä¢ /jadwal - Lihat semua jadwal\n";
      help += "‚Ä¢ /tambah_jadwal HH:MM - Tambah jadwal baru\n";
      help += "‚Ä¢ /hapus_jadwal HH:MM - Hapus jadwal\n\n";
      help += "üìä Data:\n";
      help += "‚Ä¢ /data - Ringkasan data feeding\n";
      help += "‚Ä¢ /reboot - Restart sistem";
      bot.sendMessage(chat_id, help, "");
    }
    else {
      String error = "‚ùì Perintah tidak dikenali: " + text + "\n\n";
      error += "Gunakan /menu untuk melihat perintah yang tersedia\n";
      error += "atau /help untuk bantuan lengkap.";
      bot.sendMessage(chat_id, error, "");
    }
  }
}

String TelegramHandler::getMenuText() {
  String menu = "üêπ HAMSTER FEEDER MENU\n";
  menu += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
  menu += "üìä /status - Status lengkap sistem\n";
  menu += "üçΩÔ∏è /info_makan - Informasi makanan\n";
  menu += "üíß /info_minum - Informasi minuman\n";
  menu += "ü•Ñ /makan - Beri makan sekarang\n";
  menu += "‚è∞ /jadwal - Lihat jadwal auto feed\n";
  menu += "‚ûï /tambah_jadwal HH:MM - Tambah jadwal\n";
  menu += "‚ûñ /hapus_jadwal HH:MM - Hapus jadwal\n";
  menu += "üìà /data - Lihat ringkasan data\n";
  menu += "üîÑ /reboot - Restart sistem\n";
  menu += "üÜò /help - Bantuan lengkap\n";
  menu += "üìã /menu - Menu ini\n\n";
  menu += "üí° Tip: Gunakan /help untuk panduan detail";
  return menu;
}

String TelegramHandler::getStatusText() {
  String status = "üìä STATUS SISTEM HAMSTER FEEDER\n";
  status += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
  
  // Battery status
  float battVolt = Hardware::getBatteryVolt();
  int battPercent = Hardware::getBatteryPercent();
  status += "üîã Baterai: " + String(battVolt, 1) + "V (" + String(battPercent) + "%)\n";
  if (battPercent > 50) status += "    Status: Baik ‚úÖ\n";
  else if (battPercent > 20) status += "    Status: Sedang ‚ö†Ô∏è\n";
  else status += "    Status: Rendah ‚ùå\n";
  
  // WiFi status
  status += "üì∂ WiFi: ";
  if (WiFi.status() == WL_CONNECTED) {
    status += "Terhubung ‚úÖ\n";
    status += "    IP: " + WiFi.localIP().toString() + "\n";
    status += "    RSSI: " + String(WiFi.RSSI()) + " dBm\n";
  } else {
    status += "Terputus ‚ùå\n";
  }
  
  // Food and water levels
  int food = Hardware::getFoodLevel();
  int water = Hardware::getWaterLevel();
  
  status += "üçΩÔ∏è Makanan: " + String(food) + "%\n";
  status += "üíß Minuman: " + String(water) + "%\n";
  
  // Time and feeding info
  status += "‚è∞ Waktu: " + TimeManager::getCurrentTimeString() + "\n";
  status += "üî¢ Total feeding: " + String(DataLogger::getTotalFeeds()) + " kali\n";
  status += "üìÖ Feeding hari ini: " + String(DataLogger::getTodayFeeds()) + " kali\n";
  
  // System uptime
  unsigned long uptime = millis() / 1000;
  int hours = uptime / 3600;
  int minutes = (uptime % 3600) / 60;
  status += "‚è±Ô∏è Uptime: " + String(hours) + "h " + String(minutes) + "m\n";
  
  // Next scheduled feeding
  String nextFeed = TimeManager::getNextScheduledTime();
  if (nextFeed != "") {
    status += "‚è≠Ô∏è Feeding berikutnya: " + nextFeed;
  }
  
  return status;
}

void TelegramHandler::sendStartupNotification() {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("Cannot send startup notification - WiFi not connected");
    return;
  }
  
  String msg = "üöÄ HAMSTER FEEDER SYSTEM STARTED\n";
  msg += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
  msg += "üì± Bot online dan siap digunakan\n";
  msg += "‚è∞ Waktu sistem: " + TimeManager::getCurrentTimeString() + "\n";
  msg += "üîã Baterai: " + String(Hardware::getBatteryPercent()) + "%\n";
  msg += "üì∂ WiFi: " + WiFi.localIP().toString() + "\n\n";
  msg += "Sistem siap melayani hamster kesayangan Anda! üêπ\n";
  msg += "Gunakan /menu untuk melihat perintah yang tersedia.";
  
  bool sent = bot.sendMessage(CHAT_ID, msg, "");
  if (sent) {
    Serial.println("‚úÖ Startup notification sent");
  } else {
    Serial.println("‚ùå Failed to send startup notification");
  }
}

void TelegramHandler::sendFoodAlert(int level, bool critical) {
  String msg = critical ? "üö® PERINGATAN KRITIS - MAKANAN HABIS!\n" : "‚ö†Ô∏è Peringatan - Makanan Rendah\n";
  msg += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
  msg += "üçΩÔ∏è Level makanan: " + String(level) + "%\n";
  
  if (critical) {
    msg += "‚ùå Status: KRITIS - Makanan hampir habis!\n";
    msg += "üîî TINDAKAN SEGERA DIPERLUKAN:\n";
    msg += "‚Ä¢ Isi ulang wadah makanan\n";
    msg += "‚Ä¢ Periksa kondisi hamster\n";
    msg += "‚Ä¢ Pastikan sistem feeding berfungsi";
  } else {
    msg += "‚ö†Ô∏è Status: Rendah - Perlu diisi ulang\n";
    msg += "üí° Saran:\n";
    msg += "‚Ä¢ Siapkan makanan cadangan\n";
    msg += "‚Ä¢ Isi ulang dalam waktu dekat";
  }
  
  msg += "\n\n‚è∞ " + TimeManager::getCurrentTimeString();
  sendMessage(msg);
}

void TelegramHandler::sendWaterAlert(int level, bool critical) {
  String msg = critical ? "üö® PERINGATAN KRITIS - AIR HABIS!\n" : "‚ö†Ô∏è Peringatan - Air Rendah\n";
  msg += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
  msg += "üíß Level air: " + String(level) + "%\n";
  
  if (critical) {
    msg += "‚ùå Status: KRITIS - Air hampir habis!\n";
    msg += "üîî TINDAKAN SEGERA DIPERLUKAN:\n";
    msg += "‚Ä¢ Isi ulang wadah air\n";
    msg += "‚Ä¢ Periksa kondisi hamster\n";
    msg += "‚Ä¢ Pastikan sistem minum berfungsi";
  } else {
    msg += "‚ö†Ô∏è Status: Rendah - Perlu diisi ulang\n";
    msg += "üí° Saran:\n";
    msg += "‚Ä¢ Siapkan air bersih\n";
    msg += "‚Ä¢ Isi ulang dalam waktu dekat";
  }
  
  msg += "\n\n‚è∞ " + TimeManager::getCurrentTimeString();
  sendMessage(msg);
}

void TelegramHandler::sendBatteryAlert(float level, bool critical) {
  String msg = critical ? "üö® PERINGATAN KRITIS - BATERAI LEMAH!\n" : "‚ö†Ô∏è Peringatan - Baterai Rendah\n";
  msg += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
  msg += "üîã Level baterai: " + String(level, 1) + "V (" + String(Hardware::getBatteryPercent()) + "%)\n";
  
  if (critical) {
    msg += "‚ùå Status: KRITIS - Sistem akan mati!\n";
    msg += "üîî TINDAKAN SEGERA:\n";
    msg += "‚Ä¢ Sambungkan charger segera\n";
    msg += "‚Ä¢ Sistem akan masuk mode hemat daya\n";
    msg += "‚Ä¢ Feeding otomatis mungkin terganggu";
  } else {
    msg += "‚ö†Ô∏è Status: Rendah - Perlu dicharge\n";
    msg += "üí° Saran:\n";
    msg += "‚Ä¢ Siapkan charger\n";
    msg += "‚Ä¢ Charge dalam waktu dekat";
  }
  
  msg += "\n\n‚è∞ " + TimeManager::getCurrentTimeString();
  sendMessage(msg);
}

void TelegramHandler::sendAutoFeedNotification(String time) {
  String msg = "üçΩÔ∏è FEEDING OTOMATIS\n";
  msg += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
  msg += "‚úÖ Hamster telah diberi makan\n";
  msg += "‚è∞ Waktu: " + time + "\n";
  msg += "üîÑ Jenis: Terjadwal otomatis\n";
  msg += "üìä Status: Berhasil\n\n";
  msg += "üêπ Selamat makan, hamster kesayangan!";
  
  sendMessage(msg);
  Serial.println("Auto feed notification sent for: " + time);
}

void TelegramHandler::sendMessage(String message) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("Cannot send message - WiFi not connected");
    return;
  }
  
  bool sent = bot.sendMessage(CHAT_ID, message, "");
  if (!sent) {
    Serial.println("Failed to send message: " + message.substring(0, 50) + "...");
  }
}

#endif // TELEGRAM_HANDLER_H